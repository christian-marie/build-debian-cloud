# This is slightly messy... it took a long, *long* time to work out how to
# do this.

mkdir -p "$imagedir/boot/grub"

echo "(hd0) $image_device_path" >"$imagedir/boot/grub/device.map"
cp "$imagedir/usr/lib/grub/i386-pc/boot.img" "$imagedir/boot/grub/boot.img"
chroot "$imagedir" grub-mkimage -d /usr/lib/grub/i386-pc -O i386-pc --output=/boot/grub/core.img
chroot "$imagedir" grub-setup -d /boot/grub --root-device='(hd0)' "$image_device_path"
echo "(hd0) /dev/vda" >"$imagedir/boot/grub/device.map"

log "GRUB installed"
